<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEO Crawler - Reports Overview</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <style>
        .reports-table {
            font-size: 0.9rem;
        }
        .url-column {
            max-width: 250px;
            word-break: break-all;
        }
        .status-badge {
            font-size: 0.75rem;
            padding: 4px 8px;
        }
        
        /* Status Code Styling */
        .status-success { background-color: #28a745; }
        .status-redirect { background-color: #ffc107; }
        .status-error { background-color: #dc3545; }
        .status-unknown { background-color: #6c757d; }
        
        .response-time {
            font-size: 0.7rem;
            color: #6c757d;
            margin-top: 2px;
        }
        
        .status-column {
            min-width: 100px;
        }
        
        .status-health-good { 
            color: #28a745;
        }
        .status-health-warning { 
            color: #fd7e14;
        }
        .status-health-danger { 
            color: #dc3545;
        }
        .status-health-info {
            color: #007bff;
        }
        .score-circle {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            margin: 0 auto;
        }
        .score-excellent { background: #28a745; }
        .score-good { background: #ffc107; color: #000; }
        .score-fair { background: #fd7e14; }
        .score-poor { background: #dc3545; }
        
        .issue-count {
            background: #dc3545;
            color: white;
            border-radius: 12px;
            padding: 2px 6px;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        .metric-item {
            font-size: 0.8rem;
            margin-bottom: 2px;
        }
        
        .table-header-sticky {
            /* Remove sticky positioning to allow natural page scrolling */
            background: #343a40;
        }
        
        .table-responsive {
            /* Remove fixed height to allow natural scrolling */
            overflow-x: auto;
        }
        
        .filter-controls {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
        }
        
        .summary-stats {
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .stat-item {
            text-align: center;
            padding: 8px 12px;
            border-radius: 6px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            margin: 2px;
        }
        
        .stat-number {
            font-size: 1.4rem;
            font-weight: bold;
            display: block;
            margin-bottom: 2px;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: #6c757d;
            font-weight: 500;
        }
        
        .version-badge-small {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: bold;
            display: inline-block;
        }
        
        .badge-sm {
            font-size: 0.6rem;
            padding: 1px 4px;
        }

        .pagination-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid #007bff;
        }

        .page-controls {
            gap: 1rem;
        }

        .pagination .page-link {
            color: #007bff;
            border-color: #dee2e6;
        }

        .pagination .page-item.active .page-link {
            background-color: #007bff;
            border-color: #007bff;
        }

        .pagination .page-link:hover {
            color: #0056b3;
            background-color: #e9ecef;
        }

        .loading-spinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-search me-2"></i>SEO Crawler
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">
                            <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/reports-overview">
                            <i class="fas fa-chart-bar me-1"></i>Reports Overview
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/browse">
                            <i class="fas fa-history me-1"></i>Browse Reports
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/batches">
                            <i class="fas fa-tasks me-1"></i>Batches
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/url-versions">
                            <i class="fas fa-code-branch me-1"></i>URL Versions
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user me-1"></i><%= user.username %>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/logout">
                                <i class="fas fa-sign-out-alt me-2"></i>Logout
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container-fluid my-4">

        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h2><i class="fas fa-chart-bar me-2"></i>SEO Reports Overview</h2>
                    <div>
                        <a href="/" class="btn btn-primary me-2">
                            <i class="fas fa-plus me-2"></i>New Analysis
                        </a>
                        <button class="btn btn-outline-success me-2 export-btn" onclick="exportToCSV()">
                            <i class="fas fa-download me-2"></i>Export CSV
                        </button>
                        <button class="btn btn-outline-danger" onclick="showBulkDeleteModal()" <% if ((typeof pagination === 'undefined' || !pagination) || pagination.totalCount === 0) { %>disabled<% } %>>
                            <i class="fas fa-trash-alt me-2"></i>Delete All Data
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Statistics -->
        <div class="summary-stats">
            <div class="row g-1">
                <div class="col-lg-2 col-md-3 col-6">
                    <div class="stat-item">
                        <span class="stat-number status-health-info"><%= (typeof pagination !== 'undefined' && pagination) ? pagination.totalCount : reports.length %></span>
                        <span class="stat-label">Total Reports</span>
                    </div>
                </div>
                <div class="col-lg-2 col-md-3 col-6">
                    <div class="stat-item">
                        <span class="stat-number status-health-good"><%= reports.filter(r => r.crawl_status === 'success').length %></span>
                        <span class="stat-label">Success</span>
                    </div>
                </div>
                <div class="col-lg-2 col-md-3 col-6">
                    <div class="stat-item">
                        <span class="stat-number status-health-danger"><%= reports.filter(r => r.crawl_status === 'failed').length %></span>
                        <span class="stat-label">Failed</span>
                    </div>
                </div>
                <div class="col-lg-2 col-md-3 col-6">
                    <div class="stat-item">
                        <span class="stat-number status-health-warning"><%= reports.filter(r => r.crawl_status === 'success' && r.seo_score >= 80).length %></span>
                        <span class="stat-label">Excellent</span>
                    </div>
                </div>
                <div class="col-lg-2 col-md-6 col-6">
                    <div class="stat-item">
                        <span class="stat-number status-health-info"><%= reports.filter(r => r.crawl_status === 'success' && r.seo_score >= 60 && r.seo_score < 80).length %></span>
                        <span class="stat-label">Good</span>
                    </div>
                </div>
                <div class="col-lg-2 col-md-6 col-6">
                    <div class="stat-item">
                        <span class="stat-number status-health-warning"><%= reports.filter(r => r.crawl_status === 'success' && r.seo_score < 60).length %></span>
                        <span class="stat-label">Needs Work</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Filter Controls -->
        <div class="filter-controls">
            <form method="GET" action="/reports-overview" id="filterForm">
                <div class="row g-2 align-items-end">
                    <!-- First Row -->
                    <div class="col-lg-2 col-md-3 col-6">
                        <label class="form-label small">Search URLs/Titles:</label>
                        <input type="text" class="form-control form-control-sm" name="search" value="<%= filters.search %>" placeholder="Search terms">
                    </div>
                    <div class="col-lg-2 col-md-3 col-6">
                        <label class="form-label small">Crawl Status:</label>
                        <select class="form-select form-select-sm" name="crawlStatus">
                            <option value="">All Status</option>
                            <option value="success" <%= filters.crawlStatus === 'success' ? 'selected' : '' %>>Success</option>
                            <option value="failed" <%= filters.crawlStatus === 'failed' ? 'selected' : '' %>>Failed</option>
                        </select>
                    </div>
                    <div class="col-lg-2 col-md-3 col-6">
                        <label class="form-label small">SEO Score:</label>
                        <select class="form-select form-select-sm" name="scoreRange">
                            <option value="">All Scores</option>
                            <option value="excellent" <%= filters.scoreRange === 'excellent' ? 'selected' : '' %>>Excellent (80+)</option>
                            <option value="good" <%= filters.scoreRange === 'good' ? 'selected' : '' %>>Good (60-79)</option>
                            <option value="fair" <%= filters.scoreRange === 'fair' ? 'selected' : '' %>>Fair (40-59)</option>
                            <option value="poor" <%= filters.scoreRange === 'poor' ? 'selected' : '' %>>Poor (0-39)</option>
                        </select>
                    </div>
                    <div class="col-lg-2 col-md-3 col-6">
                        <label class="form-label small">HTTP Status:</label>
                        <select class="form-select form-select-sm" name="httpStatus">
                            <option value="">All HTTP</option>
                            <option value="2xx" <%= filters.httpStatus === '2xx' ? 'selected' : '' %>>2xx Success</option>
                            <option value="3xx" <%= filters.httpStatus === '3xx' ? 'selected' : '' %>>3xx Redirect</option>
                            <option value="4xx" <%= filters.httpStatus === '4xx' ? 'selected' : '' %>>4xx Client Error</option>
                            <option value="5xx" <%= filters.httpStatus === '5xx' ? 'selected' : '' %>>5xx Server Error</option>
                        </select>
                    </div>
                    <div class="col-lg-2 col-md-3 col-6">
                        <label class="form-label small">Date Range:</label>
                        <select class="form-select form-select-sm" name="dateRange">
                            <option value="">All Time</option>
                            <option value="today" <%= filters.dateRange === 'today' ? 'selected' : '' %>>Today</option>
                            <option value="week" <%= filters.dateRange === 'week' ? 'selected' : '' %>>This Week</option>
                            <option value="month" <%= filters.dateRange === 'month' ? 'selected' : '' %>>This Month</option>
                            <option value="3months" <%= filters.dateRange === '3months' ? 'selected' : '' %>>Last 3 Months</option>
                        </select>
                    </div>
                    <div class="col-lg-2 col-md-3 col-6">
                        <label class="form-label small">Per Page:</label>
                        <select class="form-select form-select-sm" name="limit" onchange="this.form.submit()">
                            <option value="25" <%= (typeof pagination !== 'undefined' && pagination && pagination.limit === 25) ? 'selected' : '' %>>25</option>
                            <option value="50" <%= (typeof pagination !== 'undefined' && pagination && pagination.limit === 50) ? 'selected' : '' %>>50</option>
                            <option value="100" <%= (typeof pagination !== 'undefined' && pagination && pagination.limit === 100) ? 'selected' : '' %>>100</option>
                            <option value="250" <%= (typeof pagination !== 'undefined' && pagination && pagination.limit === 250) ? 'selected' : '' %>>250</option>
                            <option value="500" <%= (typeof pagination !== 'undefined' && pagination && pagination.limit === 500) ? 'selected' : '' %>>500</option>
                        </select>
                    </div>
                </div>
                <!-- Second Row -->
                <div class="row g-2 align-items-end mt-2">
                    <div class="col-lg-2 col-md-3 col-6">
                        <label class="form-label small">Issues Filter:</label>
                        <select class="form-select form-select-sm" name="issuesFilter">
                            <option value="">All Issues</option>
                            <option value="noissues" <%= filters.issuesFilter === 'noissues' ? 'selected' : '' %>>No Issues</option>
                            <option value="hasissues" <%= filters.issuesFilter === 'hasissues' ? 'selected' : '' %>>Has Issues</option>
                            <option value="critical" <%= filters.issuesFilter === 'critical' ? 'selected' : '' %>>Critical Issues</option>
                        </select>
                    </div>
                    <div class="col-lg-2 col-md-3 col-6">
                        <label class="form-label small">PWA Status:</label>
                        <select class="form-select form-select-sm" name="pwaStatus">
                            <option value="">All PWA</option>
                            <option value="has" <%= filters.pwaStatus === 'has' ? 'selected' : '' %>>Has PWA</option>
                            <option value="none" <%= filters.pwaStatus === 'none' ? 'selected' : '' %>>No PWA</option>
                        </select>
                    </div>
                    <div class="col-lg-2 col-md-3 col-6">
                        <label class="form-label small">Image Issues:</label>
                        <select class="form-select form-select-sm" name="imageIssues">
                            <option value="">All Images</option>
                            <option value="noalt" <%= filters.imageIssues === 'noalt' ? 'selected' : '' %>>Missing Alt Text</option>
                            <option value="goodalt" <%= filters.imageIssues === 'goodalt' ? 'selected' : '' %>>Good Alt Text</option>
                        </select>
                    </div>
                    <div class="col-lg-2 col-md-3 col-6">
                        <label class="form-label small">Schema Count:</label>
                        <select class="form-select form-select-sm" name="schemaPresent">
                            <option value="">All Schema</option>
                            <option value="none" <%= filters.schemaPresent === 'none' ? 'selected' : '' %>>No Schema (0)</option>
                            <option value="few" <%= filters.schemaPresent === 'few' ? 'selected' : '' %>>Few Schemas (1-2)</option>
                            <option value="some" <%= filters.schemaPresent === 'some' ? 'selected' : '' %>>Some Schemas (3-5)</option>
                            <option value="many" <%= filters.schemaPresent === 'many' ? 'selected' : '' %>>Many Schemas (6+)</option>
                        </select>
                    </div>
                    <div class="col-lg-4 col-md-6 col-12">
                        <div class="d-flex gap-1">
                            <button type="submit" class="btn btn-primary btn-sm flex-fill">
                                <i class="fas fa-search me-1"></i>Apply
                            </button>
                            <a href="/reports-overview" class="btn btn-outline-secondary btn-sm flex-fill">
                                <i class="fas fa-times me-1"></i>Clear
                            </a>
                            <button type="button" class="btn btn-outline-info btn-sm" onclick="toggleAdvancedFilters()">
                                <i class="fas fa-cog"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <input type="hidden" name="page" value="<%= (typeof pagination !== 'undefined' && pagination) ? pagination.currentPage : 1 %>">
            </form>
        </div>

        <!-- Pagination Controls (Top) -->
        <% if (typeof pagination !== 'undefined' && pagination && pagination.totalPages > 1) { %>
        <div class="d-flex justify-content-between align-items-center mb-3 page-controls">
            <div class="pagination-info">
                <i class="fas fa-info-circle text-primary me-2"></i>
                Showing <%= ((pagination.currentPage - 1) * pagination.limit) + 1 %>-<%= Math.min(pagination.currentPage * pagination.limit, pagination.totalCount) %> of <%= pagination.totalCount %> reports
                (Page <%= pagination.currentPage %> of <%= pagination.totalPages %>)
            </div>
            <nav aria-label="Reports pagination">
                <ul class="pagination pagination-sm mb-0">
                    <li class="page-item <%= !pagination.hasPrevPage ? 'disabled' : '' %>">
                        <a class="page-link" href="?<%= new URLSearchParams(Object.assign({}, filters, {page: pagination.currentPage - 1, limit: pagination.limit})).toString() %>">
                            <i class="fas fa-chevron-left"></i> Previous
                        </a>
                    </li>
                    
                    <% for (let i = Math.max(1, pagination.currentPage - 2); i <= Math.min(pagination.totalPages, pagination.currentPage + 2); i++) { %>
                        <li class="page-item <%= i === pagination.currentPage ? 'active' : '' %>">
                            <a class="page-link" href="?<%= new URLSearchParams(Object.assign({}, filters, {page: i, limit: pagination.limit})).toString() %>"><%= i %></a>
                        </li>
                    <% } %>
                    
                    <li class="page-item <%= !pagination.hasNextPage ? 'disabled' : '' %>">
                        <a class="page-link" href="?<%= new URLSearchParams(Object.assign({}, filters, {page: pagination.currentPage + 1, limit: pagination.limit})).toString() %>">
                            Next <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>
            <div class="d-flex align-items-center gap-2">
                <% if (pagination.totalPages > 10) { %>
                <div class="input-group input-group-sm" style="width: 120px;">
                    <input type="number" class="form-control" placeholder="Page" min="1" max="<%= pagination.totalPages %>" 
                           value="<%= pagination.currentPage %>" id="gotoPage">
                    <button class="btn btn-outline-secondary" onclick="goToPage()">Go</button>
                </div>
                <% } %>
            </div>
        </div>
        <% } %>

        <!-- Reports Table -->
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i>Detailed Reports Analysis
                    <span class="badge bg-primary ms-2">
                        <%= (typeof pagination !== 'undefined' && pagination) ? `${reports.length} of ${pagination.totalCount}` : reports.length %> reports
                    </span>
                </h5>
            </div>
            <div class="table-responsive">
                <table class="table table-hover reports-table mb-0" id="reportsTable">
                    <thead class="table-dark table-header-sticky">
                        <tr>
                            <th width="200">URL</th>
                            <th width="60" class="text-center">Version</th>
                            <th width="80" class="text-center">Crawl Status</th>
                            <th width="100" class="text-center status-column">HTTP Status</th>
                            <th width="80" class="text-center">SEO Score</th>
                            <th width="150">Title & Meta</th>
                            <th width="120">Content</th>
                            <th width="120">Images</th>
                            <th width="120">Links</th>
                            <th width="120">Schema</th>
                            <th width="100">PWA</th>
                            <th width="80">Issues</th>
                            <th width="120">Analyzed</th>
                            <th width="100">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (reports.length === 0) { %>
                            <tr>
                                <td colspan="14" class="text-center py-5">
                                    <div class="text-muted">
                                        <i class="fas fa-search fa-3x mb-3"></i>
                                        <h5>No reports found</h5>
                                        <p>Try adjusting your filters or create a new analysis</p>
                                        <a href="/" class="btn btn-primary">
                                            <i class="fas fa-plus me-2"></i>Create First Report
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        <% } else { %>
                            <% reports.forEach(report => { 
                                const data = JSON.parse(report.analysis_data);
                                const recommendations = JSON.parse(report.recommendations);
                                const isFailed = report.crawl_status === 'failed';
                                
                                // Calculate metrics with safe defaults
                                const titleLength = data.meta ? (data.meta.title || '').length : 0;
                                const descLength = data.meta ? (data.meta.description || '').length : 0;
                                const h1Count = data.headings && data.headings.h1 ? data.headings.h1.length : 0;
                                const imageCount = Array.isArray(data.images) ? data.images.length : 0;
                                const missingAlt = Array.isArray(data.images) ? data.images.filter(img => !img.hasAlt).length : 0;
                                const linkCount = Array.isArray(data.links) ? data.links.length : 0;
                                const internalLinks = Array.isArray(data.links) ? data.links.filter(link => link.type === 'internal').length : 0;
                                const externalLinks = Array.isArray(data.links) ? data.links.filter(link => link.type === 'external').length : 0;
                                const schemaCount = data.schema && data.schema.summary ? 
                                  (data.schema.summary.totalSchemas || 
                                   ((data.schema.jsonLd ? data.schema.jsonLd.length : 0) + 
                                    (data.schema.microdata ? data.schema.microdata.length : 0) + 
                                    (data.schema.rdfa ? data.schema.rdfa.length : 0))) : 0;
                                const hasPWA = data.pwa ? !!data.pwa.hasManifest : false;
                                const totalIssues = Array.isArray(recommendations) ? recommendations.filter(r => r.type === 'critical' || r.type === 'warning').length : 0;
                                
                                // Status code styling
                                const statusCode = data.statusCode || 0;
                                let statusClass = 'status-unknown';
                                let statusText = 'Unknown';
                                if (isFailed) {
                                    statusClass = 'status-error';
                                    statusText = 'Failed';
                                } else if (statusCode >= 200 && statusCode < 300) {
                                    statusClass = 'status-success';
                                    statusText = 'Success';
                                } else if (statusCode >= 300 && statusCode < 400) {
                                    statusClass = 'status-redirect';
                                    statusText = 'Redirect';
                                } else if (statusCode >= 400) {
                                    statusClass = 'status-error';
                                    statusText = 'Error';
                                }
                                
                                // Score styling
                                let scoreClass = 'score-poor';
                                if (!isFailed) {
                                    if (report.seo_score >= 80) scoreClass = 'score-excellent';
                                    else if (report.seo_score >= 60) scoreClass = 'score-good';
                                    else if (report.seo_score >= 40) scoreClass = 'score-fair';
                                }
                            %> 
                            <tr class="<%= isFailed ? 'table-danger-subtle' : '' %>">
                                <td class="url-column">
                                    <div class="fw-bold text-truncate" title="<%= report.url %>">
                                        <% if (isFailed) { %>
                                            <i class="fas fa-exclamation-triangle text-danger me-1"></i>
                                            <%= report.url.replace(/^https?:\/\//, '').substring(0, 35) %>...
                                        <% } else { %>
                                            <a href="<%= report.url %>" target="_blank" class="text-decoration-none">
                                                <i class="fas fa-external-link-alt me-1 text-muted"></i>
                                                <%= report.url.replace(/^https?:\/\//, '').substring(0, 35) %>...
                                            </a>
                                        <% } %>
                                    </div>
                                    <div class="text-muted small text-truncate" title="<%= report.title %>">
                                        <%= report.title.substring(0, 40) %>...
                                    </div>
                                    <% if (isFailed && data.error && data.error.message) { %>
                                        <div class="text-danger small mt-1">
                                            <i class="fas fa-info-circle me-1"></i>Error: <%= data.error.message.substring(0, 30) %>...
                                        </div>
                                    <% } %>
                                </td>
                                
                                <!-- Version Column -->
                                <td class="text-center">
                                    <% if (report.version_number && report.total_crawls) { %>
                                        <div class="version-badge-small">
                                            v<%= report.version_number %>
                                        </div>
                                        <% if (report.total_crawls > 1) { %>
                                            <small class="text-muted d-block">of <%= report.total_crawls %></small>
                                            <% if (report.version_number === report.current_version) { %>
                                                <span class="badge bg-success badge-sm">Latest</span>
                                            <% } %>
                                        <% } %>
                                    <% } else { %>
                                        <span class="text-muted">v1</span>
                                    <% } %>
                                </td>
                                
                                <td class="text-center">
                                    <% if (isFailed) { %>
                                        <span class="badge bg-danger" data-bs-toggle="tooltip" title="Crawl Failed">
                                            <i class="fas fa-times me-1"></i>Failed
                                        </span>
                                    <% } else { %>
                                        <span class="badge bg-success" data-bs-toggle="tooltip" title="Crawl Successful">
                                            <i class="fas fa-check me-1"></i>Success
                                        </span>
                                    <% } %>
                                </td>
                                
                                <td class="text-center">
                                    <% if (isFailed) { %>
                                        <span class="badge bg-secondary" data-bs-toggle="tooltip" title="No HTTP status - crawl failed">
                                            N/A
                                        </span>
                                    <% } else { %>
                                        <span class="badge <%= statusClass %>" data-bs-toggle="tooltip" title="<%= statusText %> - <%= statusCode %>">
                                            <%= statusCode %>
                                        </span>
                                        <% if (data.statusInfo && data.statusInfo.responseTime) { %>
                                            <div class="response-time"><%= data.statusInfo.responseTime %>ms</div>
                                        <% } %>
                                    <% } %>
                                </td>
                                
                                <td class="text-center">
                                    <div class="score-circle <%= scoreClass %>">
                                        <%= report.seo_score %>
                                    </div>
                                </td>
                                
                                <td>
                                    <% if (isFailed) { %>
                                        <div class="text-muted text-center">
                                            <i class="fas fa-times-circle text-danger"></i>
                                            <div class="small">N/A</div>
                                        </div>
                                    <% } else { %>
                                        <div class="metric-item">
                                            <i class="fas fa-heading text-primary"></i>
                                            Title: <%= titleLength %>/60
                                            <% if (titleLength < 30 || titleLength > 60) { %>
                                                <i class="fas fa-exclamation-triangle text-warning ms-1"></i>
                                            <% } else { %>
                                                <i class="fas fa-check text-success ms-1"></i>
                                            <% } %>
                                        </div>
                                        <div class="metric-item">
                                            <i class="fas fa-align-left text-info"></i>
                                            Meta: <%= descLength %>/160
                                            <% if (descLength < 120 || descLength > 160) { %>
                                                <i class="fas fa-exclamation-triangle text-warning ms-1"></i>
                                            <% } else { %>
                                                <i class="fas fa-check text-success ms-1"></i>
                                            <% } %>
                                        </div>
                                        <div class="metric-item">
                                            <i class="fas fa-hashtag text-secondary"></i>
                                            H1: <%= h1Count %>
                                            <% if (h1Count !== 1) { %>
                                                <i class="fas fa-exclamation-triangle text-warning ms-1"></i>
                                            <% } else { %>
                                                <i class="fas fa-check text-success ms-1"></i>
                                            <% } %>
                                        </div>
                                    <% } %>
                                </td>
                                
                                <td>
                                    <% if (isFailed) { %>
                                        <div class="text-muted text-center">
                                            <i class="fas fa-times-circle text-danger"></i>
                                            <div class="small">N/A</div>
                                        </div>
                                    <% } else { %>
                                        <div class="metric-item">
                                            <i class="fas fa-file-alt text-primary"></i>
                                            Words: <%= data.content ? (data.content.wordCount || 0) : 0 %>
                                        </div>
                                        <div class="metric-item">
                                            <i class="fas fa-list text-info"></i>
                                            Headings: <%= data.headings ? Object.values(data.headings).flat().length : 0 %>
                                        </div>
                                    <% } %>
                                </td>
                                
                                <td>
                                    <% if (isFailed) { %>
                                        <div class="text-muted text-center">
                                            <i class="fas fa-times-circle text-danger"></i>
                                            <div class="small">N/A</div>
                                        </div>
                                    <% } else { %>
                                        <div class="metric-item">
                                            <i class="fas fa-images text-primary"></i>
                                            Total: <%= imageCount %>
                                        </div>
                                        <div class="metric-item">
                                            <i class="fas fa-eye-slash text-danger"></i>
                                            Missing Alt: <%= missingAlt %>
                                            <% if (missingAlt > 0) { %>
                                                <i class="fas fa-exclamation-triangle text-warning ms-1"></i>
                                            <% } else { %>
                                                <i class="fas fa-check text-success ms-1"></i>
                                            <% } %>
                                        </div>
                                    <% } %>
                                </td>
                                
                                <td>
                                    <% if (isFailed) { %>
                                        <div class="text-muted text-center">
                                            <i class="fas fa-times-circle text-danger"></i>
                                            <div class="small">N/A</div>
                                        </div>
                                    <% } else { %>
                                        <div class="metric-item">
                                            <i class="fas fa-link text-primary"></i>
                                            Total: <%= linkCount %>
                                        </div>
                                        <div class="metric-item">
                                            <i class="fas fa-home text-success"></i>
                                            Internal: <%= internalLinks %>
                                        </div>
                                    <% } %>
                                </td>
                                
                                <td>
                                    <% if (isFailed) { %>
                                        <div class="text-muted text-center">
                                            <i class="fas fa-times-circle text-danger"></i>
                                            <div class="small">N/A</div>
                                        </div>
                                    <% } else { %>
                                        <div class="metric-item">
                                            <i class="fas fa-code text-primary"></i>
                                            Found: <%= schemaCount %>
                                            <% if (schemaCount === 0) { %>
                                                <i class="fas fa-exclamation-triangle text-warning ms-1"></i>
                                            <% } else { %>
                                                <i class="fas fa-check text-success ms-1"></i>
                                            <% } %>
                                        </div>
                                    <% } %>
                                </td>
                                
                                <td>
                                    <% if (isFailed) { %>
                                        <div class="text-muted text-center">
                                            <i class="fas fa-times-circle text-danger"></i>
                                            <div class="small">N/A</div>
                                        </div>
                                    <% } else { %>
                                        <div class="metric-item">
                                            <i class="fas fa-mobile text-primary"></i>
                                            <% if (hasPWA) { %>
                                                <span class="badge bg-success">Has PWA</span>
                                            <% } else { %>
                                                <span class="badge bg-secondary">No PWA</span>
                                            <% } %>
                                        </div>
                                    <% } %>
                                </td>
                                
                                <td class="text-center">
                                    <% if (isFailed) { %>
                                        <span class="badge bg-danger">Failed</span>
                                    <% } else if (totalIssues > 0) { %>
                                        <span class="issue-count"><%= totalIssues %></span>
                                    <% } else { %>
                                        <i class="fas fa-check-circle text-success"></i>
                                    <% } %>
                                </td>
                                
                                <td class="text-muted small">
                                    <%= new Date(report.created_at).toLocaleDateString() %>
                                    <br>
                                    <%= new Date(report.created_at).toLocaleTimeString() %>
                                </td>
                                
                                <td>
                                    <div class="btn-group-vertical btn-group-sm">
                                        <a href="/report/<%= report.id %>" class="btn btn-outline-primary btn-sm" title="View Report">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        
                                        <% if (report.total_crawls && report.total_crawls > 1) { %>
                                            <a href="/url-history?url=<%= encodeURIComponent(report.url) %>" class="btn btn-outline-info btn-sm" title="View History">
                                                <i class="fas fa-history"></i>
                                            </a>
                                        <% } %>
                                        
                                        <button class="btn btn-outline-danger btn-sm" onclick="deleteReport(<%= report.id %>)" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <% }); %>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pagination Controls (Bottom) -->
        <% if (typeof pagination !== 'undefined' && pagination && pagination.totalPages > 1) { %>
        <div class="d-flex justify-content-between align-items-center mt-4 page-controls">
            <div class="text-muted">
                Showing <%= ((pagination.currentPage - 1) * pagination.limit) + 1 %>-<%= Math.min(pagination.currentPage * pagination.limit, pagination.totalCount) %> of <%= pagination.totalCount %> reports
            </div>
            <nav aria-label="Reports pagination">
                <ul class="pagination pagination-sm mb-0">
                    <li class="page-item <%= !pagination.hasPrevPage ? 'disabled' : '' %>">
                        <a class="page-link" href="?<%= new URLSearchParams(Object.assign({}, filters, {page: pagination.currentPage - 1, limit: pagination.limit})).toString() %>">
                            <i class="fas fa-chevron-left"></i> Previous
                        </a>
                    </li>
                    
                    <% for (let i = Math.max(1, pagination.currentPage - 2); i <= Math.min(pagination.totalPages, pagination.currentPage + 2); i++) { %>
                        <li class="page-item <%= i === pagination.currentPage ? 'active' : '' %>">
                            <a class="page-link" href="?<%= new URLSearchParams(Object.assign({}, filters, {page: i, limit: pagination.limit})).toString() %>"><%= i %></a>
                        </li>
                    <% } %>
                    
                    <li class="page-item <%= !pagination.hasNextPage ? 'disabled' : '' %>">
                        <a class="page-link" href="?<%= new URLSearchParams(Object.assign({}, filters, {page: pagination.currentPage + 1, limit: pagination.limit})).toString() %>">
                            Next <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
        <% } %>
    </main>

    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loadingSpinner">
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-2">Loading reports...</div>
        </div>
    </div>

    <!-- Bulk Delete Modal -->
    <div class="modal fade" id="bulkDeleteModal" tabindex="-1" aria-labelledby="bulkDeleteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="bulkDeleteModalLabel">
                        <i class="fas fa-exclamation-triangle me-2"></i>Delete All Data
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger" role="alert">
                        <h6 class="alert-heading">
                            <i class="fas fa-exclamation-circle me-2"></i>Warning: This action cannot be undone!
                        </h6>
                        <p>This will permanently delete:</p>
                        <ul class="mb-3">
                            <li>All SEO reports</li>
                            <li>All URL versions and history</li>
                            <li>All batch jobs and queues</li>
                            <li>All analysis data</li>
                        </ul>
                        <div id="dataCountsInfo" class="mb-3">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <span class="ms-2">Loading data counts...</span>
                        </div>
                        <hr>
                        <p class="mb-2"><strong>To confirm, please type <code>DELETE ALL DATA</code> below:</strong></p>
                        <input type="text" class="form-control" id="deleteConfirmation" placeholder="Type confirmation text here">
                        <div class="invalid-feedback">
                            Please type "DELETE ALL DATA" exactly as shown.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn" onclick="performBulkDelete()" disabled>
                        <i class="fas fa-trash-alt me-2"></i>Delete All Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Helper function to build pagination URLs
        function buildPaginationUrl(page) {
            const url = new URL(window.location.href);
            url.searchParams.set('page', page);
            return url.toString();
        }

        // Function to go to specific page
        function goToPage() {
            const pageInput = document.getElementById('gotoPage');
            const pageNumber = parseInt(pageInput.value);
            const maxPages = <%= (typeof pagination !== 'undefined' && pagination) ? pagination.totalPages : 1 %>;
            
            if (pageNumber && pageNumber >= 1 && pageNumber <= maxPages) {
                window.location.href = buildPaginationUrl(pageNumber);
            } else {
                alert(`Please enter a valid page number between 1 and ${maxPages}`);
            }
        }

        // Export to CSV (current page)
        function exportToCSV() {
            const table = document.getElementById('reportsTable');
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            
            const headers = ['URL', 'Status Code', 'Response Time', 'SEO Score', 'Title Length', 'Meta Length', 'H1 Count', 'Images', 'Missing Alt', 'Links', 'Schema Count', 'PWA Status', 'Issues', 'Date'];
            
            const csvContent = [
                headers.join(','),
                ...rows.map(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length < 14) return ''; // Skip empty rows
                    
                    return [
                        `"${cells[0].textContent.trim()}"`,
                        cells[3].querySelector('.badge')?.textContent.trim() || 'N/A',
                        cells[3].querySelector('.response-time')?.textContent.replace('ms', '') || '0',
                        cells[4].querySelector('.score-circle')?.textContent.trim() || '0',
                        cells[5].textContent.match(/Title: (\d+)/)?.[1] || '0',
                        cells[5].textContent.match(/Meta: (\d+)/)?.[1] || '0',
                        cells[5].textContent.match(/H1: (\d+)/)?.[1] || '0',
                        cells[7].textContent.match(/Total: (\d+)/)?.[1] || '0',
                        cells[7].textContent.match(/Missing Alt: (\d+)/)?.[1] || '0',
                        cells[8].textContent.match(/Total: (\d+)/)?.[1] || '0',
                        cells[9].textContent.match(/Found: (\d+)/)?.[1] || '0',
                        cells[10].textContent.includes('Has PWA') ? 'Has PWA' : 'No PWA',
                        cells[11].querySelector('.issue-count')?.textContent || '0',
                        `"${cells[12].textContent.trim()}"`
                    ].join(',');
                }).filter(row => row) // Remove empty rows
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `seo-reports-page-${<%= (typeof pagination !== 'undefined' && pagination) ? pagination.currentPage : 1 %>}-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Delete report
        async function deleteReport(id) {
            if (!confirm('Are you sure you want to delete this report?')) return;
            
            try {
                const response = await fetch(`/api/report/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Failed to delete report');
                }
            } catch (error) {
                alert('Error deleting report');
            }
        }

        // Show loading spinner on form submit and navigation
        function showLoading() {
            document.getElementById('loadingSpinner').style.display = 'block';
        }

        // Show bulk delete modal
        function showBulkDeleteModal() {
            // Reset modal state
            document.getElementById('deleteConfirmation').value = '';
            document.getElementById('confirmDeleteBtn').disabled = true;
            document.getElementById('deleteConfirmation').classList.remove('is-invalid', 'is-valid');
            
            // Load data counts
            loadDataCounts();
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('bulkDeleteModal'));
            modal.show();
        }
        
        // Load data counts for deletion confirmation
        async function loadDataCounts() {
            const countsDiv = document.getElementById('dataCountsInfo');
            try {
                const response = await fetch('/api/data-counts');
                if (response.ok) {
                    const counts = await response.json();
                    countsDiv.innerHTML = `
                        <div class="bg-light p-3 rounded">
                            <h6 class="mb-2">Current data in database:</h6>
                            <div class="row g-2">
                                <div class="col-6">
                                    <div class="text-center">
                                        <div class="fs-4 fw-bold text-danger">${counts.reports}</div>
                                        <div class="small text-muted">Reports</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="text-center">
                                        <div class="fs-4 fw-bold text-danger">${counts.versions}</div>
                                        <div class="small text-muted">URL Versions</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="text-center">
                                        <div class="fs-4 fw-bold text-danger">${counts.batches}</div>
                                        <div class="small text-muted">Batches</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="text-center">
                                        <div class="fs-4 fw-bold text-danger">${counts.queue}</div>
                                        <div class="small text-muted">Queue Jobs</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    countsDiv.innerHTML = '<div class="alert alert-warning">Unable to load data counts</div>';
                }
            } catch (error) {
                countsDiv.innerHTML = '<div class="alert alert-warning">Unable to load data counts</div>';
            }
        }
        
        // Perform bulk delete
        async function performBulkDelete() {
            const confirmText = document.getElementById('deleteConfirmation').value;
            
            if (confirmText !== 'DELETE ALL DATA') {
                document.getElementById('deleteConfirmation').classList.add('is-invalid');
                return;
            }
            
            // Disable button and show loading
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Deleting...';
            
            try {
                const response = await fetch('/api/bulk-delete-all', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ confirmText })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Hide modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('bulkDeleteModal'));
                    modal.hide();
                    
                    // Show success message and reload
                    alert('All data has been successfully deleted. The page will now reload.');
                    window.location.reload();
                } else {
                    alert('Error: ' + (result.error || 'Failed to delete data'));
                    confirmBtn.disabled = false;
                    confirmBtn.innerHTML = '<i class="fas fa-trash-alt me-2"></i>Delete All Data';
                }
            } catch (error) {
                alert('Error: Failed to delete data. Please try again.');
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = '<i class="fas fa-trash-alt me-2"></i>Delete All Data';
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Add loading spinner to form submissions and pagination clicks
            const filterForm = document.getElementById('filterForm');
            if (filterForm) {
                filterForm.addEventListener('submit', showLoading);
            }

            // Add loading to pagination links
            const paginationLinks = document.querySelectorAll('.pagination .page-link:not([href="#"])');
            paginationLinks.forEach(link => {
                link.addEventListener('click', showLoading);
            });

            // Allow Enter key to submit go to page
            const pageInput = document.getElementById('gotoPage');
            if (pageInput) {
                pageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        goToPage();
                    }
                });
            }
            
            // Delete confirmation input handler
            const deleteConfirmInput = document.getElementById('deleteConfirmation');
            if (deleteConfirmInput) {
                deleteConfirmInput.addEventListener('input', function() {
                    const confirmBtn = document.getElementById('confirmDeleteBtn');
                    const isValid = this.value === 'DELETE ALL DATA';
                    confirmBtn.disabled = !isValid;
                    
                    if (this.value.length > 0) {
                        this.classList.toggle('is-valid', isValid);
                        this.classList.toggle('is-invalid', !isValid);
                    } else {
                        this.classList.remove('is-valid', 'is-invalid');
                    }
                });
            }
        });

        // Global function for EJS template
        window.buildPaginationUrl = function(page) {
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('page', page);
            return currentUrl.pathname + currentUrl.search;
        };
    </script>
</body>
</html>